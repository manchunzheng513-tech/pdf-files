{
  "name": "PDFçœŸå®æµ‹è¯•qwen",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        272,
        -336
      ],
      "id": "21843dd7-a4e1-4bb5-8316-494ad8520a14",
      "name": "When clicking â€˜Execute workflowâ€™"
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "59880ac2-b3c8-4b91-a1e3-a587680c5b79",
      "name": "Chat Input",
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "position": [
        304,
        -80
      ],
      "webhookId": "1727c687-aed0-49cf-96af-e7796819fbb3",
      "typeVersion": 1
    },
    {
      "parameters": {
        "jsCode": "// åœ¨Prepare ContextèŠ‚ç‚¹ä¸­ä¼˜åŒ–\nconst systemPrompt = `ä½ æ˜¯ä¸€ä¸ªèŒä¸šè§„åˆ’é¡¾é—®ã€‚è¯·åŸºäºä»¥ä¸‹ä¸Šä¸‹æ–‡ä¿¡æ¯å›ç­”å…³äºèŒä¸šè§„åˆ’çš„é—®é¢˜ã€‚\n\nä¸Šä¸‹æ–‡ä¿¡æ¯ï¼š\n${context}\n\nè¦æ±‚ï¼š\n1. åŸºäºæ–‡æ¡£å†…å®¹æä¾›ä¸“ä¸šçš„èŒä¸šè§„åˆ’å»ºè®®\n2. é‡ç‚¹å…³æ³¨SWOTåˆ†æã€è¡ŒåŠ¨æ–¹æ¡ˆã€è¯„ä¼°ä¿®æ­£ç­‰å†…å®¹\n3. å›ç­”è¦å…·æœ‰å»ºè®¾æ€§å’ŒæŒ‡å¯¼æ€§\n4. å¦‚æœä¸Šä¸‹æ–‡æ²¡æœ‰ç›¸å…³ä¿¡æ¯ï¼Œè¯·å¦‚å®è¯´æ˜\n\né—®é¢˜ï¼š${query}\nè¯·åŸºäºæ–‡æ¡£å†…å®¹å›ç­”ï¼š`;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1216,
        -80
      ],
      "id": "67e6246b-a174-4e26-a4d7-bc8d7b694b91",
      "name": "Prepare Context"
    },
    {
      "parameters": {
        "jsCode": "// æ¸è¿›å¼æ”¹è¿›çš„PDFæ•°æ®å¤„ç†\nconst item = $input.item;\n\nconsole.log('=== æ™ºèƒ½PDFæ•°æ®å¤„ç† ===');\n\n// æ£€æµ‹æ•°æ®æ¥æºç±»å‹\nlet dataSource = 'unknown';\nlet texts = [];\n\n// æ¥æº1: ä»çœŸå®PDFåŠ è½½å™¨æ¥çš„æ•°æ®ï¼ˆä¸ºæœªæ¥å‡†å¤‡ï¼‰\nif (item.json.document && item.json.document.pageContent) {\n  dataSource = 'real_pdf';\n  texts = [item.json.document.pageContent];\n  console.log('âœ… æ£€æµ‹åˆ°çœŸå®PDFæ–‡æ¡£æ•°æ®');\n}\n// æ¥æº2: ä»ä¸Šæ¸¸æ¨¡æ‹ŸèŠ‚ç‚¹æ¥çš„æ•°æ®  \nelse if ($('Code in JavaScript').all() && $('Code in JavaScript').all().length > 0) {\n  const upstreamItem = $('Code in JavaScript').all()[0];\n  if (upstreamItem.json.texts) {\n    dataSource = 'simulated';\n    texts = upstreamItem.json.texts;\n    console.log('ğŸ”„ ä½¿ç”¨ä¸Šæ¸¸æ¨¡æ‹Ÿæ•°æ®');\n  }\n}\n// æ¥æº3: å¤‡ç”¨çœŸå®å†…å®¹\nelse {\n  dataSource = 'fallback_real';\n  texts = [\n    \"æ¯”ç‰¹å¸ï¼šä¸€ç§ç‚¹å¯¹ç‚¹ç”µå­ç°é‡‘ç³»ç»Ÿ - çº¯ç²¹çš„ç‚¹å¯¹ç‚¹ç‰ˆæœ¬ç”µå­ç°é‡‘å°†å…è®¸åœ¨çº¿æ”¯ä»˜ç›´æ¥ä»ä¸€æ–¹å‘é€åˆ°å¦ä¸€æ–¹ï¼Œè€Œæ— éœ€é€šè¿‡é‡‘èæœºæ„ã€‚\",\n    \"æ•°å­—ç­¾åæä¾›äº†éƒ¨åˆ†è§£å†³æ–¹æ¡ˆï¼Œä½†å¦‚æœä»ç„¶éœ€è¦å¯ä¿¡ç¬¬ä¸‰æ–¹æ¥é˜²æ­¢åŒé‡æ”¯ä»˜ï¼Œåˆ™ä¸»è¦ä¼˜åŠ¿å°±ä¸§å¤±äº†ã€‚\",\n    \"æˆ‘ä»¬æå‡ºä¸€ç§ä½¿ç”¨ç‚¹å¯¹ç‚¹ç½‘ç»œè§£å†³åŒé‡æ”¯ä»˜é—®é¢˜çš„è§£å†³æ–¹æ¡ˆã€‚ç½‘ç»œé€šè¿‡å°†äº¤æ˜“å“ˆå¸Œè¿›ä¸€ä¸ªæŒç»­çš„å·¥ä½œé‡è¯æ˜é“¾æ¥æ—¶é—´æˆ³è®°äº¤æ˜“ï¼Œå½¢æˆæ— æ³•æ›´æ”¹çš„äº¤æ˜“è®°å½•ã€‚\",\n    \"å·¥ä½œé‡è¯æ˜æ¶‰åŠæ‰«æä¸€ä¸ªå€¼ï¼Œå½“è¯¥å€¼è¢«å“ˆå¸Œæ—¶ï¼ˆä¾‹å¦‚ä½¿ç”¨SHA-256ï¼‰ï¼Œå“ˆå¸Œä»¥ä¸€å®šæ•°é‡çš„é›¶ä½å¼€å§‹ã€‚å¹³å‡æ‰€éœ€å·¥ä½œéšç€æ‰€éœ€é›¶ä½æ•°é‡å‘ˆæŒ‡æ•°å¢é•¿ï¼Œå¹¶é€šè¿‡æ‰§è¡Œå•ä¸ªå“ˆå¸Œæ¥éªŒè¯ã€‚\",\n    \"ç½‘ç»œèŠ‚ç‚¹å§‹ç»ˆå°†æœ€é•¿çš„é“¾è§†ä¸ºæ­£ç¡®çš„é“¾ï¼Œå¹¶æŒç»­åŠªåŠ›æ‰©å±•å®ƒã€‚å¦‚æœä¸¤ä¸ªèŠ‚ç‚¹åŒæ—¶å¹¿æ’­ä¸åŒç‰ˆæœ¬çš„ä¸‹ä¸€ä¸ªå—ï¼Œæœ‰äº›èŠ‚ç‚¹å¯èƒ½å…ˆæ”¶åˆ°å…¶ä¸­ä¸€ä¸ªã€‚\",\n    \"èŠ‚ç‚¹åœ¨å®ƒä»¬é¦–å…ˆæ”¶åˆ°çš„å—ä¸Šå·¥ä½œï¼Œä½†ä¿å­˜å¦ä¸€ä¸ªåˆ†æ”¯ï¼Œä»¥é˜²å®ƒå˜å¾—æ›´é•¿ã€‚å½“ä¸‹ä¸€ä¸ªå·¥ä½œé‡è¯æ˜æ‰¾åˆ°å¹¶ä¸”ä¸€ä¸ªåˆ†æ”¯å˜å¾—æ›´é•¿æ—¶ï¼Œå¹³å±€è¢«æ‰“ç ´ï¼›åœ¨å¦ä¸€ä¸ªåˆ†æ”¯ä¸Šå·¥ä½œçš„èŠ‚ç‚¹ç„¶ååˆ‡æ¢åˆ°æ›´é•¿çš„åˆ†æ”¯ã€‚\"\n  ];\n  console.log('ğŸ“ ä½¿ç”¨å¢å¼ºçš„å¤‡ç”¨çœŸå®å†…å®¹');\n}\n\n// è®¾ç½®è¾“å‡º\nitem.json.file_name = \"bitcoin.pdf\";\nitem.json.file_url = \"https://bitcoin.org/bitcoin.pdf\"; \nitem.json.texts = texts;\nitem.json.data_source = dataSource;\n\n// ç¡®ä¿äºŒè¿›åˆ¶æ•°æ®å…¼å®¹æ€§\nif (!item.binary && item.json.response && item.json.response.body) {\n    item.binary = {\n        data: {\n            data: item.json.response.body,\n            mimeType: \"application/pdf\", \n            fileName: \"bitcoin.pdf\"\n        }\n    };\n}\n\nconsole.log(`æ•°æ®æ¥æº: ${dataSource}`);\nconsole.log(`å¤„ç†æ–‡æœ¬å—æ•°é‡: ${texts.length}`);\ntexts.forEach((text, index) => {\n  console.log(`æ–‡æœ¬å— ${index + 1}: ${text.substring(0, 80)}...`);\n});\n\nreturn item;\n// åœ¨ \"Code in JavaScriptå¤„ç†æ•°æ®\" èŠ‚ç‚¹çš„returnä¹‹å‰æ·»åŠ ï¼š\n// æ„å»ºå®Œæ•´çš„åƒé—®åµŒå…¥è¯·æ±‚ä½“\nitem.json.qianwen_request_body = {\n  \"model\": \"text-embedding-v1\",\n  \"input\": {\n    \"texts\": item.json.texts\n  }\n};\n\nconsole.log('æ„å»ºçš„è¯·æ±‚ä½“:', JSON.stringify(item.json.qianwen_request_body, null, 2));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        880,
        -336
      ],
      "id": "eab948b4-4784-470a-82cf-aab17a7294b8",
      "name": "Code in JavaScriptå¤„ç†æ•°æ®"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://dashscope.aliyuncs.com/api/v1/services/embeddings/text-embedding/text-embedding",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "Bearer sk-653cc34b4b70413cb887e098839f5e48"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.final_embedding_request }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1520,
        -336
      ],
      "id": "b3e6ea34-2963-449c-98b5-41e2e8424986",
      "name": "Qianwen Embeddings"
    },
    {
      "parameters": {
        "jsCode": "// å¤„ç†åƒé—®åµŒå…¥å“åº”å¹¶å‡†å¤‡Pineconeæ•°æ®\nconst item = $input.item;\n\nconsole.log('=== å¤„ç†åµŒå…¥å‘é‡ ===');\n\n// è§£æåƒé—®åµŒå…¥å“åº”\nlet vectors = [];\n\nif (item.json.output && item.json.output.embeddings) {\n  const embeddings = item.json.output.embeddings;\n  const texts = item.json.texts || []; // ä½¿ç”¨åŠ¨æ€æ–‡æœ¬\n  \n  if (embeddings.length !== texts.length) {\n    console.warn(`âš ï¸ åµŒå…¥å‘é‡æ•°é‡(${embeddings.length})ä¸æ–‡æœ¬æ•°é‡(${texts.length})ä¸åŒ¹é…`);\n  }\n  \n  // å‡†å¤‡Pinecone upsertæ ¼å¼\n  vectors = embeddings.map((embeddingObj, index) => {\n    const text = texts[index] || `æ–‡æœ¬å— ${index}`;\n    return {\n      id: `chunk_${index}_${Date.now()}`,\n      values: embeddingObj.embedding,\n      metadata: {\n        text: text.substring(0, 500), // é™åˆ¶æ–‡æœ¬é•¿åº¦\n        source: \"bitcoin.pdf\",\n        chunk: index,\n        data_source: item.json.data_source || 'unknown'\n      }\n    };\n  });\n  \n  console.log(`âœ… ç”Ÿæˆ ${vectors.length} ä¸ªå‘é‡`);\n} else {\n  console.error('âŒ æœªæ‰¾åˆ°åµŒå…¥å‘é‡æ•°æ®');\n  // åˆ›å»ºå¤‡ç”¨å‘é‡ä»¥ç¡®ä¿æµç¨‹ç»§ç»­\n  vectors = [{\n    id: `fallback_${Date.now()}`,\n    values: Array(1536).fill(0.1),\n    metadata: {\n      text: \"æ¯”ç‰¹å¸ç³»ç»ŸåŸºç¡€ä»‹ç»\",\n      source: \"bitcoin.pdf\",\n      chunk: 0,\n      data_source: 'fallback'\n    }\n  }];\n}\n\nitem.json.vectors = vectors;\n\n// ç”Ÿæˆå®Œæ•´çš„ Pinecone upsert è¯·æ±‚ä½“\nitem.json.pinecone_request = {\n  \"vectors\": item.json.vectors\n};\n\n// å°†è¯·æ±‚ä½“åºåˆ—åŒ–ä¸º JSON å­—ç¬¦ä¸²\nitem.json.pinecone_body = JSON.stringify(item.json.pinecone_request);\n\nconsole.log('Pinecone è¯·æ±‚ä½“å‡†å¤‡å®Œæˆ');\nreturn item;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1728,
        -336
      ],
      "id": "1bd36606-45d7-4d1b-be84-47e10d3006b1",
      "name": "Process Embeddings"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://pdf-chat-index-75fiy11.svc.aped-4627-b74a.pinecone.io/vectors/upsert",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Api-Key",
              "value": "pcsk_MB5Pb_J8yWGq9k4iR12v2GuqVCoMokzuHsRaNfToqc8GQioceAh1LZDgbbB3ZLwH8rW7J"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "json",
        "body": "={\n  \"vectors\": {{JSON.stringify($json.vectors)}}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1936,
        -336
      ],
      "id": "d2b29df0-7458-4689-a1c6-a7ea4f4b0504",
      "name": "Pinecone Upsert"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://dashscope.aliyuncs.com/api/v1/services/embeddings/text-embedding/text-embedding",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "Bearer sk-653cc34b4b70413cb887e098839f5e48"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"text-embedding-v1\",\n  \"input\": {\n    \"texts\": [\n      \"æ¯”ç‰¹å¸æ˜¯ä»€ä¹ˆï¼Ÿ\"\n    ]\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        480,
        128
      ],
      "id": "6f00902f-db7d-4e68-8c36-831fc582f514",
      "name": "Query Embeddings"
    },
    {
      "parameters": {
        "jsCode": "// å¤„ç†åµŒå…¥å“åº” - æå–æŸ¥è¯¢å‘é‡\nconst item = $input.item;\n\nconsole.log('=== å¼€å§‹å¤„ç†åµŒå…¥å“åº” ===');\n\n// 1. éªŒè¯APIå“åº”ç»“æ„\nif (!item.json.output) {\n  throw new Error('APIå“åº”ç¼ºå°‘outputå­—æ®µ');\n}\n\nif (!item.json.output.embeddings) {\n  throw new Error('APIå“åº”ç¼ºå°‘embeddingså­—æ®µ');\n}\n\nif (item.json.output.embeddings.length === 0) {\n  throw new Error('embeddingsæ•°ç»„ä¸ºç©º');\n}\n\n// 2. æå–ç¬¬ä¸€ä¸ªåµŒå…¥å‘é‡ï¼ˆç”¨æˆ·é—®é¢˜çš„å‘é‡ï¼‰\nconst embeddingData = item.json.output.embeddings[0];\n\nif (!embeddingData.embedding) {\n  throw new Error('åµŒå…¥å‘é‡æ•°æ®ç¼ºå¤±');\n}\n\n// 3. å­˜å‚¨æŸ¥è¯¢å‘é‡å’Œç”¨æˆ·é—®é¢˜\nitem.json.query_vector = embeddingData.embedding;\n\n// ç¡¬ç¼–ç æµ‹è¯•é—®é¢˜ - è¿™æ ·è‡³å°‘å¯ä»¥è®©æµç¨‹ç»§ç»­\nitem.json.user_query = \"æ¯”ç‰¹å¸æ˜¯ä»€ä¹ˆï¼Ÿ\";\nconsole.log('ä½¿ç”¨ç¡¬ç¼–ç é—®é¢˜:', item.json.user_query);\n\n// 4. è®°å½•è°ƒè¯•ä¿¡æ¯\nconsole.log('âœ… å‘é‡æå–æˆåŠŸ');\nconsole.log('ç”¨æˆ·é—®é¢˜:', item.json.user_query);\nconsole.log('å‘é‡ç»´åº¦:', item.json.query_vector.length);\n\n// 5. æ•°æ®å®Œæ•´æ€§æ£€æŸ¥\nif (item.json.query_vector.length !== 1536) {\n  console.warn('âš ï¸ å‘é‡ç»´åº¦ä¸æ˜¯é¢„æœŸçš„1536ï¼Œå®é™…ä¸º:', item.json.query_vector.length);\n}\n\nconsole.log('=== åµŒå…¥å“åº”å¤„ç†å®Œæˆ ===');\n\nreturn item;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        784,
        128
      ],
      "id": "50d07d02-8416-44ad-a5a0-09485b4ca687",
      "name": "Process Query Embeddings"
    },
    {
      "parameters": {
        "jsCode": "// å‡†å¤‡ Pinecone æŸ¥è¯¢è¯·æ±‚ä½“\nconst item = $input.item;\n\nconsole.log('æŸ¥è¯¢å‘é‡ç»´åº¦:', item.json.query_vector ? item.json.query_vector.length : 'æ— ');\n\n// æ£€æŸ¥å‘é‡æ•°æ®å®Œæ•´æ€§\nif (!item.json.query_vector || item.json.query_vector.length !== 1536) {\n  throw new Error(`å‘é‡æ•°æ®å¼‚å¸¸: æœŸæœ›1536ç»´ï¼Œå®é™…${item.json.query_vector ? item.json.query_vector.length : 'æ— '}ç»´`);\n}\n\n// æ„å»ºæŸ¥è¯¢è¯·æ±‚ - ä½¿ç”¨æ­£ç¡®çš„Pineconeæ ¼å¼\nconst queryBody = {\n  \"vector\": item.json.query_vector,\n  \"topK\": 3,\n  \"includeMetadata\": true,\n  \"includeValues\": false\n};\n\n// å°†è¯·æ±‚ä½“è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²\nitem.json.pinecone_body = JSON.stringify(queryBody);\n\nconsole.log('Pinecone æŸ¥è¯¢è¯·æ±‚ä½“é•¿åº¦:', item.json.pinecone_body.length);\nconsole.log('å‘é‡å‰10ä¸ªå€¼:', item.json.query_vector.slice(0, 10));\nconsole.log('Pinecone æŸ¥è¯¢è¯·æ±‚ä½“å‡†å¤‡å®Œæˆ');\nreturn item;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        928,
        -96
      ],
      "id": "7689d8dd-fb22-495b-943a-f04138e0621f",
      "name": "Prepare Pinecone Query"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://pdf-chat-index-75fiy11.svc.aped-4627-b74a.pinecone.io/query",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Api-Key",
              "value": "pcsk_MB5Pb_J8yWGq9k4iR12v2GuqVCoMokzuHsRaNfToqc8GQioceAh1LZDgbbB3ZLwH8rW7J"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.pinecone_body }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1088,
        128
      ],
      "id": "03e40dcc-f395-4aac-a766-ee4f1739aaf6",
      "name": "Pinecone Query"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "Bearer sk-653cc34b4b70413cb887e098839f5e48"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"qwen-turbo\",\n  \"input\": {\n    \"messages\": [\n      {\n        \"role\": \"system\",\n        \"content\": \"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–‡æ¡£åŠ©æ‰‹ã€‚è¯·åŸºäºç”¨æˆ·æä¾›çš„ä¸Šä¸‹æ–‡ä¿¡æ¯å›ç­”é—®é¢˜ã€‚å¦‚æœä¸Šä¸‹æ–‡ä¸­æœ‰ç›¸å…³ä¿¡æ¯ï¼Œè¯·åŸºäºè¿™äº›ä¿¡æ¯å›ç­”ï¼›å¦‚æœä¸Šä¸‹æ–‡æ²¡æœ‰ç›¸å…³ä¿¡æ¯ï¼Œè¯·å¦‚å®è¯´æ˜ã€‚è¯·ç›´æ¥å›ç­”é—®é¢˜ï¼Œä¸è¦è¦æ±‚ç”¨æˆ·æé—®ã€‚\"\n      },\n      {\n        \"role\": \"user\",\n        \"content\": \"ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼šæ¯”ç‰¹å¸æ˜¯ä¸€ç§ç‚¹å¯¹ç‚¹çš„ç”µå­ç°é‡‘ç³»ç»Ÿï¼Œå…è®¸åœ¨çº¿æ”¯ä»˜ç›´æ¥ä»ä¸€æ–¹å‘é€åˆ°å¦ä¸€æ–¹ï¼Œè€Œæ— éœ€é€šè¿‡é‡‘èæœºæ„ã€‚\\n\\né—®é¢˜ï¼šæ¯”ç‰¹å¸æ˜¯ä»€ä¹ˆï¼Ÿ\\n\\nè¯·åŸºäºä¸Šä¸‹æ–‡ä¿¡æ¯ç›´æ¥å›ç­”ä¸Šè¿°é—®é¢˜ï¼š\"\n      }\n    ]\n  },\n  \"parameters\": {\n    \"result_format\": \"message\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1360,
        128
      ],
      "id": "15951aee-faf5-4d3e-8f7f-769f4f9d7ac7",
      "name": "Qianwen AI Response"
    },
    {
      "parameters": {
        "jsCode": "// è°ƒè¯•ï¼šæ£€æŸ¥ Query Embeddings çš„è¾“å‡º\nconst item = $input.item;\n\nconsole.log('=== Query Embeddings è¾“å‡ºè°ƒè¯• ===');\nconsole.log('æ‰€æœ‰JSONå­—æ®µ:', Object.keys(item.json));\nconsole.log('chatInput å€¼:', item.json.chatInput);\nconsole.log('chatInput ç±»å‹:', typeof item.json.chatInput);\nconsole.log('å®Œæ•´çš„JSONæ•°æ®:', JSON.stringify(item.json, null, 2));\n\n// æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–å¯èƒ½åŒ…å«ç”¨æˆ·é—®é¢˜çš„å­—æ®µ\nfor (let key in item.json) {\n  if (typeof item.json[key] === 'string' && item.json[key].length > 0) {\n    console.log('å­—ç¬¦ä¸²å­—æ®µ:', key, '=', item.json[key]);\n  }\n}\n\nreturn item;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        640,
        -96
      ],
      "id": "d84f631e-266d-454d-a2b6-eedca20ac683",
      "name": "Debug Chat Input"
    },
    {
      "parameters": {
        "jsCode": "// ç”Ÿæˆæœ€ç»ˆå“åº”æ ¼å¼\nconst item = $input.item;\n\n// ä»åƒé—®APIå“åº”ä¸­æå–å›ç­”\nlet answer = \"\";\nif (item.json.output && item.json.output.choices && item.json.output.choices.length > 0) {\n  const choice = item.json.output.choices[0];\n  if (choice.message && choice.message.content) {\n    answer = choice.message.content;\n  }\n}\n\n// å¦‚æœæ²¡æœ‰è·å–åˆ°å›ç­”ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ\nif (!answer) {\n  answer = \"æŠ±æ­‰ï¼Œæˆ‘æ— æ³•åŸºäºæä¾›çš„æ–‡æ¡£ç”Ÿæˆå›ç­”ã€‚\";\n}\n\nlet response = answer;\n\n// æ·»åŠ å¼•ç”¨ä¿¡æ¯\nif (item.json.matches && item.json.matches.length > 0) {\n  response += \"\\\\n\\\\n**å¼•ç”¨æ¥æº**ï¼š\";\n  // é»˜è®¤å¼•ç”¨å‰ä¸¤ä¸ªç›¸å…³æ–‡æ¡£\n  const citations = item.json.matches.slice(0, 2);\n  citations.forEach((match, index) => {\n    const source = match.metadata;\n    response += `\\\\n- ${source.source} (éƒ¨åˆ†${source.chunk + 1})`;\n  });\n}\n\nitem.json.final_response = response;\nitem.json.chatOutput = response;\n\nconsole.log('æœ€ç»ˆå“åº”ç”Ÿæˆå®Œæˆ:', response);\nreturn item;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1520,
        -80
      ],
      "id": "cb992834-2274-45d9-b946-8fb9c289aeb1",
      "name": "Generate Final Response1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        112,
        -576
      ],
      "typeVersion": 1,
      "id": "71b6bb23-fb65-4dc6-9d47-f850121669ca",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "jsCode": "// é…ç½®çœŸå®PDFæ–‡æ¡£ - ç”Ÿæ¶¯æŠ¥å‘Šä¹¦\nconst item = $input.item;\n\nconsole.log('ğŸš€ é…ç½®ç”Ÿæ¶¯æŠ¥å‘Šä¹¦PDFæ–‡æ¡£');\n\n// è®¾ç½®ä½ çš„PDFæ–‡æ¡£ä¿¡æ¯\nitem.json.file_name = \"ç”Ÿæ¶¯æŠ¥å‘Šä¹¦.pdf\";\nitem.json.file_url = \"https://your-domain.com/ç”Ÿæ¶¯æŠ¥å‘Šä¹¦.pdf\";  // æ›¿æ¢ä¸ºä½ çš„å®é™…PDF URL\n\n// æ–‡æ¡£æè¿°\nitem.json.document_description = \"æ–‡ç§˜ä¸“ä¸šæ•™è‚²äººå‘˜èŒä¸šè§„åˆ’æŠ¥å‘Š\";\nitem.json.document_type = \"career_planning\";\nitem.json.author = \"æ–‡ç§˜ä¸“ä¸šå­¦ç”Ÿ\";\n\nconsole.log('âœ… ç”Ÿæ¶¯æŠ¥å‘Šä¹¦é…ç½®å®Œæˆ');\nconsole.log('æ–‡æ¡£åç§°:', item.json.file_name);\nconsole.log('æ–‡æ¡£ç±»å‹:', item.json.document_type);\n\n// åˆå§‹åŒ–æ–‡æœ¬å†…å®¹\nitem.json.texts = [\n  \"æ­£åœ¨åŠ è½½ç”Ÿæ¶¯æŠ¥å‘Šä¹¦å†…å®¹...\"\n];\n\nreturn item;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        480,
        -336
      ],
      "id": "b11f3e3b-9d51-4cd6-b186-049774049462",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "jsCode": "// è°ƒè¯•ä¸Šæ¸¸æ•°æ®\nconst item = $input.item;\n\nconsole.log('=== ä¸Šæ¸¸æ•°æ®è°ƒè¯• ===');\nconsole.log('1. texts æ•°ç»„å†…å®¹:', item.json.texts);\nconsole.log('2. texts ç±»å‹:', typeof item.json.texts);\nconsole.log('3. æ˜¯æ•°ç»„å—:', Array.isArray(item.json.texts));\n\nif (Array.isArray(item.json.texts)) {\n  console.log('4. æ•°ç»„é•¿åº¦:', item.json.texts.length);\n  item.json.texts.forEach((text, index) => {\n    console.log(`   æ–‡æœ¬${index}: ${text.substring(0, 50)}...`);\n  });\n} else {\n  console.log('4. texts ä¸æ˜¯æ•°ç»„ï¼Œå®é™…å€¼:', item.json.texts);\n}\n\n// æµ‹è¯•è¡¨è¾¾å¼è§£æ\nconsole.log('5. æµ‹è¯•è¡¨è¾¾å¼è§£æ:');\nconst testExpr = \"={{ $json.texts }}\";\nconsole.log('   è¡¨è¾¾å¼:', testExpr);\n\nreturn item;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        688,
        -336
      ],
      "id": "bb3b9010-e57d-46c8-974c-099cfcae32b9",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "69bf5aa8-5b9e-436b-b7d0-6efb9788675d",
              "name": "model",
              "value": "text-embedding-v2",
              "type": "string"
            },
            {
              "id": "6dde734a-48a5-49c6-b1de-68bf75df61b4",
              "name": "texts_array",
              "value": "={{ $json.texts }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1088,
        -336
      ],
      "id": "04777e38-7c21-4d3c-990c-85b34b81491d",
      "name": "text-embedding-v2"
    },
    {
      "parameters": {
        "jsCode": "// æ„å»ºåƒé—®åµŒå…¥è¯·æ±‚ä½“\nconst item = $input.item;\n\nconsole.log('=== æ„å»ºåµŒå…¥è¯·æ±‚ä½“ ===');\n\n// ç¡®ä¿ texts_array æ˜¯æ•°ç»„\nlet textsArray = [];\nif (Array.isArray(item.json.texts_array)) {\n  textsArray = item.json.texts_array;\n} else if (Array.isArray(item.json.texts)) {\n  textsArray = item.json.texts;\n} else {\n  // å¤‡ç”¨æ–¹æ¡ˆ\n  textsArray = [\n    \"æ¯”ç‰¹å¸æ˜¯ä¸€ç§ç‚¹å¯¹ç‚¹çš„ç”µå­ç°é‡‘ç³»ç»Ÿ\",\n    \"æ¯”ç‰¹å¸ä½¿ç”¨å·¥ä½œé‡è¯æ˜æœºåˆ¶\",\n    \"äº¤æ˜“è¢«è®°å½•åœ¨åŒºå—é“¾ä¸­\"\n  ];\n}\n\n// æ„å»ºå®Œæ•´çš„è¯·æ±‚ä½“å¯¹è±¡\nconst requestBody = {\n  \"model\": item.json.model || \"text-embedding-v2\",\n  \"input\": {\n    \"texts\": textsArray\n  }\n};\n\nconsole.log('è¯·æ±‚ä½“å†…å®¹:', JSON.stringify(requestBody, null, 2));\nconsole.log('æ–‡æœ¬æ•°é‡:', textsArray.length);\n\n// å°†è¯·æ±‚ä½“è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²\nitem.json.final_embedding_request = JSON.stringify(requestBody);\n\nreturn item;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1296,
        -336
      ],
      "id": "ffac2c1e-ac10-4115-bf2f-9bba8ee27af4",
      "name": "Code in JavaScript2"
    }
  ],
  "pinData": {},
  "connections": {
    "When clicking â€˜Execute workflowâ€™": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Chat Input": {
      "main": [
        [
          {
            "node": "Query Embeddings",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Context": {
      "main": [
        [
          {
            "node": "Qianwen AI Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScriptå¤„ç†æ•°æ®": {
      "main": [
        [
          {
            "node": "text-embedding-v2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Qianwen Embeddings": {
      "main": [
        [
          {
            "node": "Process Embeddings",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Embeddings": {
      "main": [
        [
          {
            "node": "Pinecone Upsert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query Embeddings": {
      "main": [
        [
          {
            "node": "Debug Chat Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Query Embeddings": {
      "main": [
        [
          {
            "node": "Prepare Pinecone Query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Pinecone Query": {
      "main": [
        [
          {
            "node": "Pinecone Query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pinecone Query": {
      "main": [
        [
          {
            "node": "Prepare Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Chat Input": {
      "main": [
        [
          {
            "node": "Process Query Embeddings",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Qianwen AI Response": {
      "main": [
        [
          {
            "node": "Generate Final Response1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Code in JavaScriptå¤„ç†æ•°æ®",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "text-embedding-v2": {
      "main": [
        [
          {
            "node": "Code in JavaScript2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript2": {
      "main": [
        [
          {
            "node": "Qianwen Embeddings",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "8d8f3cd6-e0b3-443a-9a88-9c71e5590cea",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "c9036fa4f39de74ace8f0580e8b6ce9df7806084c56c9b2cef0f8436e81b4d68"
  },
  "id": "Q1APCqJ5XDFMorRB",
  "tags": []
}